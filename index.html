import React, { useState, useEffect, useRef } from 'react';
import { Plus, ShoppingCart, ChefHat, Package, ExternalLink, Trash2, Edit2, MapPin, Check, X, Search, ArrowRight, Info, Upload, Image as ImageIcon, CalendarCheck } from 'lucide-react';

// --- è«å…°è¿ªè‰²ç³»é…ç½® & å·¥å…·å‡½æ•° ---
const colors = {
  bg: '#F5F5F7', // ææ·¡çš„æš–ç°èƒŒæ™¯
  card: '#FFFFFF',
  primary: '#9D8CA1', // è«å…°è¿ªç´«
  primaryLight: '#E6E1E8',
  secondary: '#DCC4CA', // è«å…°è¿ªç²‰
  textMain: '#4A4A4A', // æ·±ç°æ–‡å­—
  textSub: '#8C8C8C', // æµ…ç°æ–‡å­—
  accent: '#A8B0BC', // é›¾éœ¾è“ç°
  danger: '#E5989B', // æŸ”å’Œçš„çº¢
  success: '#9AB8A6', // è«å…°è¿ªç»¿
};

const locations = [
  { id: 'de', name: 'å¾·è¶…', color: 'bg-stone-200 text-stone-700' },
  { id: 'cn', name: 'äºšè¶…', color: 'bg-rose-100 text-rose-700' },
  { id: 'tr', name: 'åœŸè¶…', color: 'bg-orange-100 text-orange-800' },
];

const placeholderImg = "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=800&q=80";

// --- é»˜è®¤åˆå§‹æ•°æ® (ä»…å½“æœ¬åœ°æ— æ•°æ®æ—¶ä½¿ç”¨) ---
const INITIAL_RECIPES = [
  {
    id: 1,
    name: 'ç•ªèŒ„æ»‘è›‹ç‰›è‚‰',
    type: '15min',
    image: 'https://images.unsplash.com/photo-1627207644006-277564b22349?auto=format&fit=crop&w=800&q=80',
    link: 'https://www.xiaohongshu.com',
    ingredients: [
      { name: 'ç‰›è‚‰å·', quantity: '1', location: 'cn' },
      { name: 'ç•ªèŒ„', quantity: '3', location: 'de' },
      { name: 'é¸¡è›‹', quantity: '2', location: 'de' }
    ]
  },
  {
    id: 2,
    name: 'è¿·è¿­é¦™çƒ¤ç¾Šæ’',
    type: 'other',
    image: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80',
    link: '',
    ingredients: [
      { name: 'ç¾Šæ’', quantity: '4', location: 'tr' },
      { name: 'è¿·è¿­é¦™', quantity: '1', location: 'de' }
    ]
  }
];

// --- æ ¸å¿ƒç»„ä»¶ ---

export default function KitchenApp() {
  const [activeTab, setActiveTab] = useState('recipes');
  const [showPagoda, setShowPagoda] = useState(false);
  
  // å…¨å±€æç¤ºçŠ¶æ€
  const [toast, setToast] = useState({ show: false, message: '' });
  // å…¨å±€ç¡®è®¤æ¡†çŠ¶æ€
  const [confirmModal, setConfirmModal] = useState({ show: false, title: '', onConfirm: null });

  // --- è¾…åŠ© hookï¼šå¸¦æœ¬åœ°å­˜å‚¨çš„ State ---
  // è¿™ä¸ª Hook ç¡®ä¿äº†åˆ·æ–°é¡µé¢åæ•°æ®ä¾ç„¶å­˜åœ¨ï¼Œè¿™æ˜¯ PWA ä½“éªŒçš„å…³é”®
  const usePersistentState = (key, initialValue) => {
    const [state, setState] = useState(() => {
      try {
        const item = window.localStorage.getItem(key);
        return item ? JSON.parse(item) : initialValue;
      } catch (error) {
        console.error("Error reading localStorage:", error);
        return initialValue;
      }
    });

    useEffect(() => {
      try {
        window.localStorage.setItem(key, JSON.stringify(state));
      } catch (error) {
        console.error("Error saving to localStorage:", error);
      }
    }, [key, state]);

    return [state, setState];
  };

  // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæç¤º
  const showToast = (msg) => {
    setToast({ show: true, message: msg });
    setTimeout(() => setToast({ show: false, message: '' }), 3000);
  };

  // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç¡®è®¤æ¡†
  const requestConfirm = (title, action) => {
    setConfirmModal({ show: true, title, onConfirm: action });
  };

  // --- æ•°æ®çŠ¶æ€ (ä½¿ç”¨æŒä¹…åŒ– Hook) ---
  const [recipes, setRecipes] = usePersistentState('muse_recipes', INITIAL_RECIPES);
  
  const [cart, setCart] = usePersistentState('muse_cart', [
    { id: 101, name: 'ç‰›å¥¶', quantity: '2', location: 'de', checked: false }
  ]);

  const [inventory, setInventory] = usePersistentState('muse_inventory', [
    { id: 201, name: 'ç”ŸæŠ½', quantity: '1', category: 'seasoning', location: 'cn' },
    { id: 202, name: 'æ„å¤§åˆ©é¢', quantity: '2', category: 'food', location: 'de' }
  ]);

  const [mealPlan, setMealPlan] = usePersistentState('muse_mealplan', [
     { id: 301, name: 'å‘¨æœ«æ™šé¤ï¼šè¿·è¿­é¦™çƒ¤ç¾Šæ’', completed: false }
  ]);

  // --- æ ¸å¿ƒé€»è¾‘ ---

  const addToCart = (items, quiet = false) => {
    const newCart = [...cart];
    items.forEach(item => {
      // ç®€å•å»é‡é€»è¾‘ï¼šå¦‚æœåŒååŒåœ°ç‚¹ä¸”æœªè´­ä¹°ï¼Œåˆ™å¢åŠ æ•°é‡(è¿™é‡Œç®€å•å¤„ç†ä¸ºè¿½åŠ ï¼Œå¯è§†éœ€æ±‚ä¼˜åŒ–)
      newCart.push({
        id: Date.now() + Math.random(),
        name: item.name,
        quantity: item.quantity || '1',
        location: item.location,
        checked: false
      });
    });
    setCart(newCart);
    if (!quiet) showToast(`å·²å°† ${items.length} ç§é£ŸæåŠ å…¥è´­ç‰©è½¦`);
  };

  const handleScheduleMeal = (recipe) => {
    // 1. åŠ è´­ç‰©è½¦
    addToCart(recipe.ingredients, true);
    
    // 2. åŠ  Meal Plan
    const newPlanItem = {
      id: Date.now(),
      name: recipe.name,
      completed: false
    };
    setMealPlan([...mealPlan, newPlanItem]);

    // 3. æç¤º
    showToast(`å·²å®‰æ’ï¼é£Ÿæå…¥åº“ï¼Œä»»åŠ¡å·²å»ºç«‹`);
  };

  const restockFromInventory = (item) => {
    addToCart([{ name: item.name, quantity: '1', location: item.location }]);
  };

  return (
    <div className="min-h-screen font-sans relative overflow-hidden selection:bg-purple-200 select-none sm:select-text" style={{ backgroundColor: colors.bg, color: colors.textMain }}>
      
      {/* å…¨å±€ Toast æç¤º */}
      <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] transition-all duration-300 pointer-events-none ${toast.show ? 'translate-y-0 opacity-100' : '-translate-y-20 opacity-0'}`}>
        <div className="bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl flex items-center space-x-2">
          <Check size={16} className="text-green-400" />
          <span className="text-sm font-medium">{toast.message}</span>
        </div>
      </div>

      {/* å…¨å±€ç¡®è®¤å¼¹çª— */}
      {confirmModal.show && (
        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm animate-in fade-in">
          <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
            <h3 className="text-lg font-bold text-slate-700 mb-2">ç¡®è®¤æ“ä½œ</h3>
            <p className="text-slate-500 mb-6">{confirmModal.title}</p>
            <div className="flex space-x-3">
              <button 
                onClick={() => setConfirmModal({ show: false, title: '', onConfirm: null })}
                className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-medium active:scale-95 transition-transform"
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={() => {
                  confirmModal.onConfirm();
                  setConfirmModal({ show: false, title: '', onConfirm: null });
                }}
                className="flex-1 py-3 text-white rounded-xl font-medium active:scale-95 transition-transform shadow-lg shadow-red-100"
                style={{ backgroundColor: colors.danger }}
              >
                åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      )}

      {/* è†³é£Ÿå®å¡”å¼¹çª— */}
      {showPagoda && <PagodaModal onClose={() => setShowPagoda(false)} />}

      {/* é¡¶éƒ¨æ ‡é¢˜æ  + å›ºå®šæ³¡æ³¡ */}
      <div className="pt-safe-top pb-4 px-6 sticky top-0 z-20 backdrop-blur-xl bg-white/50 flex items-center justify-between border-b border-white/20">
        <div className="pt-4">
          <h1 className="text-2xl font-bold tracking-tight text-slate-700">
            {activeTab === 'recipes' && 'ç§æˆ¿èœè°±'}
            {activeTab === 'cart' && 'è´­ç‰©æ¸…å•'}
            {activeTab === 'inventory' && 'å®¶åº­å­˜è´§'}
            {activeTab === 'plan' && 'ç¾é£Ÿå®‰æ’'}
          </h1>
          <p className="text-xs text-slate-400 mt-1 tracking-wider uppercase">MY KITCHEN â€¢ LIFE</p>
        </div>
        
        {/* å›ºå®šåœ¨æ ‡é¢˜æ å³ä¾§çš„å‘¼å¸æ³¡æ³¡ */}
        <div className="pt-4">
          <PulseBubble onClick={() => setShowPagoda(true)} />
        </div>
      </div>

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="pb-32 px-4 max-w-md mx-auto pt-2">
        {activeTab === 'recipes' && (
          <RecipesView 
            recipes={recipes} 
            setRecipes={setRecipes} 
            onSchedule={handleScheduleMeal}
            requestConfirm={requestConfirm}
          />
        )}
        {activeTab === 'cart' && (
          <CartView 
            cart={cart} 
            setCart={setCart}
            requestConfirm={requestConfirm} 
          />
        )}
        {activeTab === 'inventory' && (
          <InventoryView 
            inventory={inventory} 
            setInventory={setInventory} 
            onRestock={restockFromInventory}
            requestConfirm={requestConfirm}
          />
        )}
        {activeTab === 'plan' && (
          <MealPlanView 
            mealPlan={mealPlan} 
            setMealPlan={setMealPlan}
            requestConfirm={requestConfirm}
          />
        )}
      </div>

      {/* åº•éƒ¨å¯¼èˆªæ  */}
      <div className="fixed bottom-6 left-2 right-2 bg-white/90 backdrop-blur-xl rounded-full shadow-2xl shadow-purple-900/10 h-16 flex items-center justify-between px-2 z-30 max-w-md mx-auto border border-white/50 pb-safe-bottom">
        <NavButton active={activeTab === 'recipes'} onClick={() => setActiveTab('recipes')} icon={ChefHat} label="èœè°±" />
        <NavButton active={activeTab === 'cart'} onClick={() => setActiveTab('cart')} icon={ShoppingCart} label="è´­ç‰©" count={cart.filter(i => !i.checked).length} />
        <NavButton active={activeTab === 'inventory'} onClick={() => setActiveTab('inventory')} icon={Package} label="å­˜è´§" />
        <NavButton active={activeTab === 'plan'} onClick={() => setActiveTab('plan')} icon={CalendarCheck} label="å®‰æ’" count={mealPlan.filter(i => !i.completed).length} />
      </div>

    </div>
  );
}

// --- å­è§†å›¾ç»„ä»¶ ---

function MealPlanView({ mealPlan, setMealPlan, requestConfirm }) {
  const [isAdding, setIsAdding] = useState(false);
  const [newItemName, setNewItemName] = useState('');

  const toggleComplete = (id) => {
    setMealPlan(mealPlan.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
  };

  const updateItemName = (id, newName) => {
    setMealPlan(mealPlan.map(item => item.id === id ? { ...item, name: newName } : item));
  };

  const deleteItem = (id) => {
    setMealPlan(mealPlan.filter(item => item.id !== id));
  };

  const addNewItem = () => {
    if(!newItemName.trim()) return;
    setMealPlan([...mealPlan, { id: Date.now(), name: newItemName, completed: false }]);
    setNewItemName('');
    setIsAdding(false);
  };

  const pending = mealPlan.filter(i => !i.completed);
  const completed = mealPlan.filter(i => i.completed);

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="bg-gradient-to-br from-[#9D8CA1] to-[#86758a] rounded-[2rem] p-6 text-white shadow-lg shadow-purple-200 relative overflow-hidden">
        <div className="absolute top-0 right-0 p-4 opacity-10">
          <CalendarCheck size={80} />
        </div>
        <h3 className="font-bold text-lg mb-1 relative z-10">æœ¬å‘¨ç¾é£Ÿè®¡åˆ’</h3>
        <p className="text-purple-100 text-sm mb-4 relative z-10">å·²æœ‰ {pending.length} ä¸ªçƒ¹é¥ªå¾…åŠ</p>
        <div className="flex items-center space-x-2 relative z-10">
           <div className="h-1.5 flex-1 bg-purple-900/30 rounded-full overflow-hidden">
             <div 
                className="h-full bg-white/90 rounded-full transition-all duration-500 ease-out" 
                style={{ width: `${mealPlan.length ? (completed.length / mealPlan.length) * 100 : 0}%` }}
             ></div>
           </div>
           <span className="text-xs font-bold">{completed.length}/{mealPlan.length}</span>
        </div>
      </div>

      {/* å¾…åŠåˆ—è¡¨ */}
      <div className="space-y-3">
         <p className="text-xs font-bold text-slate-400 uppercase px-2">Pending â€¢ å¾…çƒ¹é¥ª</p>
         {pending.length === 0 && !isAdding && (
           <div className="text-center py-8 text-slate-300 text-sm bg-white/50 rounded-2xl border border-dashed border-slate-200">
             æš‚æ— å®‰æ’ï¼Œå»èœè°±é‡Œé€‰å‡ ä¸ªå§
           </div>
         )}
         
         {pending.map(item => (
           <TodoItem 
             key={item.id} 
             item={item} 
             onToggle={() => toggleComplete(item.id)} 
             onChange={(val) => updateItemName(item.id, val)}
             onDelete={() => deleteItem(item.id)}
           />
         ))}

         {isAdding ? (
           <div className="flex items-center space-x-2 bg-white p-2 rounded-xl border-2 border-purple-100 animate-in fade-in zoom-in-95">
             <input 
               autoFocus
               className="flex-1 bg-transparent px-2 outline-none text-slate-700"
               placeholder="è¾“å…¥è®¡åˆ’åç§°..."
               value={newItemName}
               onChange={e => setNewItemName(e.target.value)}
               onKeyDown={e => e.key === 'Enter' && addNewItem()}
             />
             <button onClick={addNewItem} className="p-2 bg-[#9D8CA1] text-white rounded-lg active:scale-95 transition-transform">
               <Check size={16} />
             </button>
           </div>
         ) : (
           <button 
             onClick={() => setIsAdding(true)}
             className="w-full py-3 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-sm font-medium hover:border-purple-200 hover:text-purple-400 hover:bg-white transition-all flex items-center justify-center space-x-2 active:scale-95"
           >
             <Plus size={16} />
             <span>æ‰‹åŠ¨æ·»åŠ è®¡åˆ’</span>
           </button>
         )}
      </div>

      {completed.length > 0 && (
        <div className="space-y-3 pt-4 border-t border-slate-100">
           <p className="text-xs font-bold text-slate-400 uppercase px-2">Completed â€¢ å·²å®Œæˆ</p>
           {completed.map(item => (
             <TodoItem 
               key={item.id} 
               item={item} 
               onToggle={() => toggleComplete(item.id)} 
               onChange={(val) => updateItemName(item.id, val)}
               onDelete={() => deleteItem(item.id)}
             />
           ))}
        </div>
      )}
    </div>
  );
}

const TodoItem = ({ item, onToggle, onChange, onDelete }) => (
  <div className={`group flex items-center bg-white p-3 rounded-xl transition-all duration-300 border border-slate-50 ${item.completed ? 'opacity-50 grayscale' : 'shadow-sm hover:shadow-md'}`}>
    <button 
      onClick={onToggle}
      className={`w-5 h-5 rounded-md border-2 mr-3 flex items-center justify-center transition-colors flex-shrink-0 ${
        item.completed 
          ? 'bg-[#9AB8A6] border-[#9AB8A6]' 
          : 'border-slate-300 hover:border-[#9D8CA1]'
      }`}
    >
      {item.completed && <Check size={12} className="text-white" />}
    </button>
    
    <input 
      className={`flex-1 bg-transparent outline-none transition-all w-full ${item.completed ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}`}
      value={item.name}
      onChange={(e) => onChange(e.target.value)}
    />
    
    <button onClick={onDelete} className="text-slate-200 hover:text-rose-400 md:opacity-0 md:group-hover:opacity-100 transition-all px-2 active:scale-90">
      <X size={16} />
    </button>
  </div>
);

function RecipesView({ recipes, setRecipes, onSchedule, requestConfirm }) {
  const [filter, setFilter] = useState('all');
  const [isEditing, setIsEditing] = useState(false);
  const [editingRecipe, setEditingRecipe] = useState(null);

  const filteredRecipes = recipes.filter(r => filter === 'all' || r.type === filter);

  const handleSave = (recipe) => {
    if (editingRecipe && recipe.id === editingRecipe.id) {
      setRecipes(recipes.map(r => r.id === recipe.id ? recipe : r));
    } else {
      setRecipes([...recipes, { ...recipe, id: Date.now() }]);
    }
    setIsEditing(false);
    setEditingRecipe(null);
  };

  const handleDelete = (id) => {
    requestConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœè°±å—ï¼Ÿ', () => {
      setRecipes(recipes.filter(r => r.id !== id));
    });
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="flex space-x-3 mb-6 overflow-x-auto pb-2 scrollbar-hide -mx-4 px-4 sm:mx-0 sm:px-0">
        {['all', '15min', 'other'].map(t => (
          <button
            key={t}
            onClick={() => setFilter(t)}
            className={`px-4 py-2 rounded-full text-sm transition-all duration-300 flex-shrink-0 ${
              filter === t 
                ? 'text-white shadow-lg shadow-purple-200' 
                : 'bg-white text-slate-500 hover:bg-slate-50'
            }`}
            style={{ backgroundColor: filter === t ? colors.primary : undefined }}
          >
            {t === 'all' ? 'å…¨éƒ¨' : t === '15min' ? 'âš¡ 15minå¿«æ‰‹' : 'ğŸ³ åŠŸå¤«èœ'}
          </button>
        ))}
      </div>

      <div className="space-y-6">
        {filteredRecipes.map(recipe => (
          <div key={recipe.id} className="bg-white rounded-[2rem] p-4 shadow-sm hover:shadow-lg transition-all duration-300 border border-slate-50">
            <div className="relative h-48 rounded-[1.5rem] overflow-hidden mb-4 group bg-slate-100">
              <img src={recipe.image || placeholderImg} alt={recipe.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
              <div className="absolute top-3 right-3 flex space-x-2 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                <button onClick={() => { setEditingRecipe(recipe); setIsEditing(true); }} className="p-2 bg-white/80 backdrop-blur rounded-full text-slate-700 hover:bg-white shadow-sm">
                  <Edit2 size={16} />
                </button>
                <button onClick={() => handleDelete(recipe.id)} className="p-2 bg-white/80 backdrop-blur rounded-full text-rose-500 hover:bg-white shadow-sm">
                  <Trash2 size={16} />
                </button>
              </div>
              {recipe.type === '15min' && (
                <div className="absolute bottom-3 left-3 px-3 py-1 bg-yellow-400/90 backdrop-blur text-white text-xs font-bold rounded-full shadow-sm">
                  15min å¿«æ‰‹
                </div>
              )}
            </div>
            
            <div className="flex justify-between items-start mb-3">
              <h3 className="text-xl font-bold text-slate-700">{recipe.name}</h3>
              {recipe.link && (
                <a href={recipe.link} target="_blank" rel="noopener noreferrer" className="text-rose-400 hover:text-rose-500 p-1">
                  <ExternalLink size={20} />
                </a>
              )}
            </div>

            <div className="space-y-2 mb-4">
              <div className="flex flex-wrap gap-2">
                {recipe.ingredients.map((ing, idx) => (
                  <span key={idx} className="px-2 py-1 bg-slate-50 rounded-lg text-sm text-slate-600 border border-slate-100">
                    {ing.name} <span className="text-slate-400 text-xs">x{ing.quantity}</span>
                  </span>
                ))}
              </div>
            </div>

            <button 
              onClick={() => onSchedule(recipe)}
              className="w-full py-3 rounded-xl flex items-center justify-center space-x-2 text-white font-medium transition-all active:scale-95 shadow-lg shadow-purple-100 hover:shadow-purple-200"
              style={{ backgroundColor: colors.secondary }}
            >
              <ShoppingCart size={18} />
              <span>å®‰æ’è¿™é¡¿é¥­</span>
            </button>
          </div>
        ))}
      </div>
      
      {/* åº•éƒ¨ä¿ç•™è¶³å¤Ÿç©ºé—´ç»™æ‚¬æµ®æŒ‰é’® */}
      <div className="h-12"></div>

      <button 
        onClick={() => { setEditingRecipe(null); setIsEditing(true); }}
        className="fixed bottom-24 right-6 p-4 rounded-full text-white shadow-xl shadow-purple-300 hover:scale-110 active:scale-90 transition-all z-40"
        style={{ backgroundColor: colors.primary }}
      >
        <Plus size={28} />
      </button>

      {isEditing && (
        <RecipeForm 
          initialData={editingRecipe} 
          onSave={handleSave} 
          onCancel={() => setIsEditing(false)} 
        />
      )}
    </div>
  );
}

function CartView({ cart, setCart, requestConfirm }) {
  const groupedCart = cart.reduce((acc, item) => {
    if (!acc[item.location]) acc[item.location] = [];
    acc[item.location].push(item);
    return acc;
  }, {});

  const toggleChec
