<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>暮食 Kitchen</title>
    
    <!-- PWA 配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=192&h=192&fit=crop">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React 基础库 (使用 cdnjs) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel 解析器 -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #F5F5F7;
            overscroll-behavior-y: none;
        }
        /* 隐藏滚动条 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 安全区域适配 */
        .pt-safe-top { padding-top: max(12px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(24px, env(safe-area-inset-bottom)); }
        
        /* 加载动画 */
        .loader {
            border: 3px solid #E6E1E8;
            border-radius: 50%;
            border-top: 3px solid #9D8CA1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- 根节点 -->
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #888;">
            <div class="loader"></div>
            <p style="margin-top: 15px; font-size: 14px;">正在启动厨房...</p>
        </div>
    </div>

    <!-- 错误监控脚本 -->
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            var container = document.getElementById('root');
            container.innerHTML = 
                '<div style="padding:20px; color:#d32f2f; font-family:monospace; background:#fff; height:100vh; overflow:auto;">' +
                '<h3 style="color:#000; font-size:18px; margin-bottom:10px;">糟糕，应用出错了</h3>' +
                '<div style="background:#ffebee; padding:15px; border-radius:8px;">' +
                '<p><strong>错误信息:</strong> ' + msg + '</p>' +
                '<p><strong>位置:</strong> 第 ' + lineNo + ' 行</p>' +
                '</div>' +
                '<p style="margin-top:20px; color:#666;">请尝试刷新页面。如果持续报错，可能是网络问题导致资源加载失败。</p>' +
                '</div>';
            return false;
        };
    </script>

    <!-- 主要业务逻辑 -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 0. 图标库 (内联 SVG，防止加载失败) ---
        const Icons = {
            ChefHat: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/>
                    <line x1="6" y1="17" x2="18" y2="17"/>
                </svg>
            ),
            ShoppingCart: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/>
                    <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                </svg>
            ),
            Package: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="m16.5 9.4-9-5.19"/><path d="m21 16-9 5.19-9-5.19"/><path d="M3 11.13V4L12 9.19l9-5.19v7.13"/><path d="m12 19.19v-10"/>
                </svg>
            ),
            CalendarCheck: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/>
                </svg>
            ),
            Plus: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M5 12h14"/><path d="M12 5v14"/>
                </svg>
            ),
            Trash2: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                </svg>
            ),
            Edit2: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                </svg>
            ),
            Check: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            ),
            X: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                </svg>
            ),
            MapPin: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
                </svg>
            ),
            ExternalLink: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/>
                </svg>
            ),
            Image: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                </svg>
            )
        };

        // --- 1. 配置与常量 ---
        const colors = {
            bg: '#F5F5F7', 
            card: '#FFFFFF', 
            primary: '#9D8CA1', 
            primaryLight: '#E6E1E8',
            secondary: '#DCC4CA', 
            textMain: '#4A4A4A', 
            textSub: '#8C8C8C', 
            accent: '#A8B0BC', 
            danger: '#E5989B', 
            success: '#9AB8A6',
        };

        const locations = [
            { id: 'de', name: '德超', color: 'bg-stone-200 text-stone-700' },
            { id: 'cn', name: '亚超', color: 'bg-rose-100 text-rose-700' },
            { id: 'tr', name: '土超', color: 'bg-orange-100 text-orange-800' },
        ];

        const placeholderImg = "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=800&q=80";

        const INITIAL_RECIPES = [
            { 
                id: 1, 
                name: '番茄滑蛋牛肉', 
                type: '15min', 
                image: 'https://images.unsplash.com/photo-1627207644006-277564b22349', 
                link: 'https://www.xiaohongshu.com', 
                ingredients: [
                    { name: '牛肉卷', quantity: '1', location: 'cn' }, 
                    { name: '番茄', quantity: '3', location: 'de' }, 
                    { name: '鸡蛋', quantity: '2', location: 'de' }
                ] 
            },
            { 
                id: 2, 
                name: '迷迭香烤羊排', 
                type: 'other', 
                image: 'https://images.unsplash.com/photo-1544025162-d76694265947', 
                link: '', 
                ingredients: [
                    { name: '羊排', quantity: '4', location: 'tr' }, 
                    { name: '迷迭香', quantity: '1', location: 'de' }
                ] 
            }
        ];

        // --- 2. 核心 App 组件 ---
        function KitchenApp() {
            const [activeTab, setActiveTab] = useState('recipes');
            const [showPagoda, setShowPagoda] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', onConfirm: null });

            // 本地存储 Hook
            const usePersistentState = (key, initialValue) => {
                const [state, setState] = useState(() => {
                    try {
                        const item = window.localStorage.getItem(key);
                        return item ? JSON.parse(item) : initialValue;
                    } catch (error) { return initialValue; }
                });
                useEffect(() => {
                    window.localStorage.setItem(key, JSON.stringify(state));
                }, [key, state]);
                return [state, setState];
            };

            const [recipes, setRecipes] = usePersistentState('muse_recipes', INITIAL_RECIPES);
            const [cart, setCart] = usePersistentState('muse_cart', [{ id: 101, name: '牛奶', quantity: '2', location: 'de', checked: false }]);
            const [inventory, setInventory] = usePersistentState('muse_inventory', [{ id: 201, name: '生抽', quantity: '1', category: 'seasoning', location: 'cn' }, { id: 202, name: '意大利面', quantity: '2', category: 'food', location: 'de' }]);
            const [mealPlan, setMealPlan] = usePersistentState('muse_mealplan', [{ id: 301, name: '周末晚餐：迷迭香烤羊排', completed: false }]);

            const showToast = (msg) => { 
                setToast({ show: true, message: msg }); 
                setTimeout(() => setToast({ show: false, message: '' }), 3000); 
            };
            
            const requestConfirm = (title, action) => { 
                setConfirmModal({ show: true, title, onConfirm: action }); 
            };

            const addToCart = (items, quiet = false) => {
                const newCart = [...cart];
                items.forEach(item => {
                    newCart.push({ 
                        id: Date.now() + Math.random(), 
                        name: item.name, 
                        quantity: item.quantity || '1', 
                        location: item.location, 
                        checked: false 
                    });
                });
                setCart(newCart);
                if (!quiet) showToast(`已将 ${items.length} 种食材加入购物车`);
            };

            const handleScheduleMeal = (recipe) => {
                addToCart(recipe.ingredients, true);
                setMealPlan([...mealPlan, { id: Date.now(), name: recipe.name, completed: false }]);
                showToast(`已安排！食材入库，任务已建立`);
            };

            return (
                <div className="min-h-screen font-sans relative overflow-hidden selection:bg-purple-200 select-none sm:select-text" style={{ backgroundColor: colors.bg, color: colors.textMain }}>
                    
                    {/* Toast 提示 */}
                    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] transition-all duration-300 pointer-events-none ${toast.show ? 'translate-y-0 opacity-100' : '-translate-y-20 opacity-0'}`}>
                        <div className="bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl flex items-center space-x-2">
                            <Icons.Check width={16} height={16} className="text-green-400" />
                            <span className="text-sm font-medium">{toast.message}</span>
                        </div>
                    </div>

                    {/* 确认弹窗 */}
                    {confirmModal.show && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                                <h3 className="text-lg font-bold text-slate-700 mb-2">确认操作</h3>
                                <p className="text-slate-500 mb-6">{confirmModal.title}</p>
                                <div className="flex space-x-3">
                                    <button 
                                        onClick={() => setConfirmModal({ show: false, title: '', onConfirm: null })} 
                                        className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-medium active:scale-95 transition-transform"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={() => { confirmModal.onConfirm(); setConfirmModal({ show: false, title: '', onConfirm: null }); }} 
                                        className="flex-1 py-3 text-white rounded-xl font-medium active:scale-95 transition-transform shadow-lg shadow-red-100" 
                                        style={{ backgroundColor: colors.danger }}
                                    >
                                        删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showPagoda && <PagodaModal onClose={() => setShowPagoda(false)} />}

                    {/* 顶部导航 */}
                    <div className="pt-safe-top pb-4 px-6 sticky top-0 z-20 backdrop-blur-xl bg-white/50 flex items-center justify-between border-b border-white/20">
                        <div className="pt-4">
                            <h1 className="text-2xl font-bold tracking-tight text-slate-700">
                                {activeTab === 'recipes' && '私房菜谱'}
                                {activeTab === 'cart' && '购物清单'}
                                {activeTab === 'inventory' && '家庭存货'}
                                {activeTab === 'plan' && '美食安排'}
                            </h1>
                            <p className="text-xs text-slate-400 mt-1 tracking-wider uppercase">MY KITCHEN • LIFE</p>
                        </div>
                        <div className="pt-4"><PulseBubble onClick={() => setShowPagoda(true)} /></div>
                    </div>

                    {/* 主要内容区域 */}
                    <div className="pb-32 px-4 max-w-md mx-auto pt-2">
                        {activeTab === 'recipes' && (
                            <RecipesView recipes={recipes} setRecipes={setRecipes} onSchedule={handleScheduleMeal} requestConfirm={requestConfirm} />
                        )}
                        {activeTab === 'cart' && (
                            <CartView cart={cart} setCart={setCart} requestConfirm={requestConfirm} />
                        )}
                        {activeTab === 'inventory' && (
                            <InventoryView 
                                inventory={inventory} 
                                setInventory={setInventory} 
                                onRestock={(item) => addToCart([{name: item.name, quantity: '1', location: item.location}])} 
                                requestConfirm={requestConfirm} 
                            />
                        )}
                        {activeTab === 'plan' && (
                            <MealPlanView mealPlan={mealPlan} setMealPlan={setMealPlan} />
                        )}
                    </div>

                    {/* 底部导航栏 */}
                    <div className="fixed bottom-6 left-2 right-2 bg-white/90 backdrop-blur-xl rounded-full shadow-2xl shadow-purple-900/10 h-16 flex items-center justify-between px-2 z-30 max-w-md mx-auto border border-white/50 pb-safe-bottom">
                        <NavButton active={activeTab === 'recipes'} onClick={() => setActiveTab('recipes')} icon={Icons.ChefHat} label="菜谱" />
                        <NavButton active={activeTab === 'cart'} onClick={() => setActiveTab('cart')} icon={Icons.ShoppingCart} label="购物" count={cart.filter(i => !i.checked).length} />
                        <NavButton active={activeTab === 'inventory'} onClick={() => setActiveTab('inventory')} icon={Icons.Package} label="存货" />
                        <NavButton active={activeTab === 'plan'} onClick={() => setActiveTab('plan')} icon={Icons.CalendarCheck} label="安排" count={mealPlan.filter(i => !i.completed).length} />
                    </div>
                </div>
            );
        }

        // --- 3. 子组件定义 ---
        
        const NavButton = ({ active, onClick, icon: Icon, label, count }) => (
            <button 
                onClick={onClick} 
                className={`relative flex flex-col items-center justify-center w-14 h-full transition-all duration-300 ${active ? 'text-[#9D8CA1]' : 'text-slate-300 hover:text-slate-400'}`}
            >
                <div className={`p-1.5 rounded-xl transition-all duration-300 ${active ? 'bg-[#F4F4F5] -translate-y-1' : ''}`}>
                    <Icon width={active?22:20} height={active?22:20} />
                </div>
                <span className="text-[10px] font-medium mt-0.5">{label}</span>
                {count > 0 && (
                    <span className="absolute top-2 right-1 w-4 h-4 bg-rose-400 text-white text-[10px] flex items-center justify-center rounded-full border-2 border-white shadow-sm">
                        {count}
                    </span>
                )}
            </button
